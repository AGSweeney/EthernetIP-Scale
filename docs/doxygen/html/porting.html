<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESP32-P4 EtherNet/IP Device: Porting OpENer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ESP32-P4 EtherNet/IP Device<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">EtherNet/IP adapter with IMU sensors and I/O expansion</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('porting.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Porting OpENer </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1 class="doxsection"><a class="anchor" id="gen_config_section"></a>
General Stack Configuration</h1>
<p>The general stack properties have to be defined prior to building your production. This is done by providing a file called <a class="el" href="opener__user__conf_8h.html">opener_user_conf.h</a>. An example file can be found in the src/ports/POSIX or src/ports/WIN32 directory. The documentation of the example file for the necessary configuration options: <a class="el" href="opener__user__conf_8h.html">opener_user_conf.h</a></p>
<h1 class="doxsection"><a class="anchor" id="startup_sec"></a>
Startup Sequence</h1>
<p>During startup of your EtherNet/IP(TM) device the following steps have to be performed:</p><ol type="1">
<li>Configure the network properties:<br  />
 With the following functions the network interface of OpENer is configured:<ul>
<li>EIP_STATUS ConfigureNetworkInterface(const char *ip_address,
       const char *subnet_mask, const char *gateway_address)</li>
<li>void ConfigureMACAddress(const EIP_UINT8 *mac_address)</li>
<li>void ConfigureDomainName(const char *domain_name)</li>
<li>void ConfigureHostName(const char *host_name)</li>
</ul>
Depending on your platform these data can come from a configuration file or from operating system functions. If these values should be setable remotely via explicit messages the SetAttributeSingle functions of the EtherNetLink and the TCPIPInterface object have to be adapted.</li>
<li>Set the device's serial number<br  />
 According to the CIP specification a device vendor has to ensure that each of its devices has a unique 32Bit device id. You can set it with the function:<ul>
<li>void setDeviceSerialNumber(EIP_UINT32 serial_number)</li>
</ul>
</li>
<li>Initialize OpENer: <br  />
 With the function CipStackInit(EIP_UINT16 unique_connection_id) the internal data structures of opener are correctly setup. After this step own CIP objects and Assembly objects instances may be created. For your convenience we provide the call-back function ApplicationInitialization. This call back function is called when the stack is ready to receive application specific CIP objects.</li>
<li>Create Application Specific CIP Objects:<br  />
 Within the call-back function <a class="el" href="group__CIP__CALLBACK__API.html#gae93106eb1647bff3ad56a7752799d878" title="Callback for the application initialization.">ApplicationInitialization(void)</a> or after CipStackInit(void) has finished you may create and configure any CIP object or Assembly object instances. See the module <a class="el" href="group__CIP__API.html">OpENer User interface</a> for available functions. Currently no functions are available to remove any created objects or instances. This is planned for future versions.</li>
<li>Setup the listening TCP and UDP port:<br  />
 THE ETHERNET/IP SPECIFICATION demands from devices to listen to TCP connections and UDP datagrams on the port AF12hex for explicit messages. Therefore before going into normal operation you need to configure your network library so that TCP and UDP messages on this port will be received and can be hand over to the Ethernet encapsulation layer.</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="normal_op_sec"></a>
Normal Operation</h1>
<p>During normal operation the following tasks have to be done by the platform specific code:</p><ul>
<li>Establish connections requested on TCP port AF12hex</li>
<li>Receive explicit message data on connected TCP sockets and the UPD socket for port AF12hex. The received data has to be hand over to Ethernet encapsulation layer with the functions: <br  />
 int HandleReceivedExplictTCPData(int socket_handle, EIP_UINT8* buffer, int
buffer_length, int *number_of_remaining_bytes),<br  />
 int HandleReceivedExplictUDPData(int socket_handle, struct sockaddr_in <em>from_address, EIP_UINT8</em> buffer, unsigned int buffer_length, int *number_of_remaining_bytes).<br  />
 Depending if the data has been received from a TCP or from a UDP socket. As a result of this function a response may have to be sent. The data to be sent is in the given buffer pa_buf.</li>
<li>Create UDP sending and receiving sockets for implicit connected messages<br  />
 OpENer will use to call-back function int CreateUdpSocket(
    UdpCommuncationDirection connection_direction,
    struct sockaddr_in *pa_pstAddr) for informing the platform specific code that a new connection is established and new sockets are necessary</li>
<li>Receive implicit connected data on a receiving UDP socket<br  />
 The received data has to be hand over to the Connection Manager Object with the function EIP_STATUS HandleReceivedConnectedData(EIP_UINT8
*data, int data_length)</li>
<li>Close UDP and TCP sockets:<ol type="1">
<li>Requested by OpENer through the call back function: void <a class="el" href="group__CIP__CALLBACK__API.html#gae04e2a3e9937e910cbcdbff0b8d6ad2b" title="Close the given socket and clean up the stack.">CloseSocket(int socket_handle)</a></li>
<li>For TCP connection when the peer closed the connection OpENer needs to be informed to clean up internal data structures. This is done with the function void <a class="el" href="group__CIP__API.html#ga00a23c1c86472edf2ed679089ae8efc1" title="Inform the encapsulation layer that the remote host has closed the connection.">CloseSession(int socket_handle)</a>.</li>
</ol>
</li>
<li>Cyclically update the connection status:<br  />
 In order that OpENer can determine when to produce new data on connections or that a connection timed out every <a class="el" href="opener__user__conf_8h.html#a646a8da99c8f1195945306e34990ece6">kOpenerTimerTickInMilliSeconds</a> milliseconds the function EIP_STATUS ManageConnections(void) has to be called.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="callback_funcs_sec"></a>
Callback Functions</h1>
<p>In order to make OpENer more platform independent and in order to inform the application on certain state changes and actions within the stack a set of call-back functions is provided. These call-back functions are declared in the file <a class="el" href="opener__api_8h.html" title="OpENer EtherNet/IP Stack Public API.">opener_api.h</a> and have to be implemented by the application specific code. An overview and explanation of OpENer's call-back API may be found in the module <a class="el" href="group__CIP__CALLBACK__API.html">Callback Functions Demanded by OpENer</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.15.0 </li>
  </ul>
</div>
</body>
</html>
